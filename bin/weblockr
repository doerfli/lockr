#!/usr/bin/env ruby

require 'lockr/http/httplockrinit'
require 'erb'
require 'clipboard'  
require 'padrino-helpers'
require 'json'

include ERB::Util

init = HttpLockrInit.new()
init.start()

# now start sinatra
require 'sinatra'
require "sinatra/json"

if init.getLoadBrowser
  require "browser_gui"  
end

register Padrino::Helpers

set :pwdmgr, init.getPwdMgr()
# server config
set :public_dir, File.expand_path('../../resources/static', __FILE__) 
set :bind, '127.0.0.1'
set :port, 32187
set :views, File.expand_path('../../resources/views', __FILE__) 
enable :run
 
get '/' do
  dir = settings.pwdmgr.list()
  erb :index, :locals => { :directory => dir }
end

get '/password' do
  id = params[:id]
  username = params[:username]
  settings.pwdmgr.copy_to_clipboard( id, username)
  redirect '/'
end

post '/password' do
  json = convertFormToMap( request.body.read)
  id = json['id']
  username = json['username']
  password = json['password']
  newPwdstore = settings.pwdmgr.add( id, username, password)
  dir = settings.pwdmgr.list()
  json({:message => "Site &quot;#{id}/#{username}&quot; added"})
end

patch '/password' do
  json = convertFormToMap( request.body.read)
  id = json['id']
  username = json['username']
  password = json['password']
  settings.pwdmgr.change( id, username, password)
  json({:message => "Password for site &quot;#{id}/#{username}&quot; updated"})
end

delete '/password' do
  id = params[:id]
  username = params[:username]
  settings.pwdmgr.delete( id, username)
  redirect '/'
end

def convertFormToMap( jsonForm)
  Hash[JSON.parse(jsonForm).map{|el| [el['name'], el['value']]}]
end